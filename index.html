<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADXL335 Tractor Tilt (GitHub Pages)</title>
  <style>
    :root{
      --bg1:#fff0f7;
      --bg2:#f5fff1;
      --card:#ffffffcc;
      --stroke:#f0cfe1;
      --text:#4a2340;
      --muted:#6b4f63;
      --accent:#ff5aa5;
      --accent2:#ffd36b;
    }
    body{
      margin:16px;
      font-family: system-ui, -apple-system, Segoe UI, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 12% 10%, #fff7cc, transparent 60%),
        radial-gradient(900px 500px at 90% 0%, var(--bg1), transparent 60%),
        radial-gradient(900px 500px at 60% 100%, var(--bg2), transparent 55%),
        linear-gradient(180deg, #fff7fb 0%, #f8fff5 100%);
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:12px;
    }
    .titleWrap h2{ margin:0; font-size:22px; letter-spacing:.2px; }
    .subtitle{ margin-top:6px; color:var(--muted); font-size:14px; line-height:1.35; }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border:1px solid var(--stroke); border-radius:999px;
      background: var(--card); box-shadow: 0 6px 18px rgba(0,0,0,.06);
      font-size:13px; color:var(--muted); white-space:nowrap;
    }
    .dot{ width:10px;height:10px;border-radius:50%; background:#c9c9c9; box-shadow: 0 0 0 4px rgba(201,201,201,.25); }
    .dot.on{ background:#34c759; box-shadow: 0 0 0 4px rgba(52,199,89,.25); }
    #row{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; align-items:start; }
    .card{
      padding:14px; border:1px solid var(--stroke); border-radius:18px;
      background: var(--card); box-shadow: 0 10px 26px rgba(0,0,0,.08);
      backdrop-filter: blur(6px);
    }
    .controls{ display:flex; gap:12px; align-items:center; margin:10px 0 12px; flex-wrap:wrap; }
    button{
      padding:10px 14px; border-radius:16px; border:1px solid var(--stroke);
      background: linear-gradient(180deg, #ffffff 0%, #fff0f8 100%);
      cursor:pointer; color:var(--text); font-weight:700;
      box-shadow: 0 10px 20px rgba(255,90,165,.12);
      transition: transform .08s ease, box-shadow .08s ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 14px 24px rgba(255,90,165,.16); }
    button:disabled{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hint{ margin-top:8px; color:var(--muted); font-size:13px; line-height:1.35; }
    #angles{ display:grid; grid-template-columns: 1fr; gap:8px; }
    .angleRow{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px; border:1px dashed #f2c7dd; border-radius:16px;
      background: rgba(255,255,255,.58);
    }
    .angleLabel{ display:flex; align-items:center; gap:10px; font-weight:800; }
    .leaf{
      width:22px;height:22px;border-radius:9px; display:grid;place-items:center;
      background: linear-gradient(180deg, #fff3fa 0%, #ffe0f0 100%);
      border:1px solid #f2c7dd;
    }
    #threeWrap{
      height: 420px; border:1px solid var(--stroke); border-radius:18px; overflow:hidden;
      background:
        radial-gradient(900px 420px at 50% 0%, rgba(255,255,255,.92), rgba(255,255,255,.35)),
        linear-gradient(180deg, #e9f8ff 0%, #fff7fb 70%);
      position:relative;
    }
    .threeLabel{
      position:absolute; left:12px; top:12px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.72); font-size:13px; color:var(--muted);
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
    }
    @media (max-width: 920px){
      #row{ grid-template-columns: 1fr; }
      #threeWrap{ height: 360px; }
    }
  </style>
</head>

<body>
  <header>
    <div class="titleWrap">
      <h2>ADXL335 Pink Tractor Tilt Dashboard üöúüíóüå∏</h2>
      <div class="subtitle">
        Reads <span class="mono">angleX,angleY,angleZ</span> over Serial (<span class="mono">115200</span>) and rotates a cute tractor.
        (Arduino MODE 4.)
      </div>
    </div>
    <div class="badge">
      <span id="connDot" class="dot"></span>
      <span id="status" class="mono">disconnected</span>
    </div>
  </header>

  <div class="controls">
    <button id="connectBtn">Connect Serial</button>
    <div class="hint">Close Arduino Serial Monitor/Plotter before connecting here.</div>
  </div>

  <div id="row">
    <div class="card">
      <div id="angles">
        <div class="angleRow">
          <div class="angleLabel"><span class="leaf">üå∏</span>AngleX</div>
          <div class="mono"><span id="ax">‚Äî</span>¬∞</div>
        </div>
        <div class="angleRow">
          <div class="angleLabel"><span class="leaf">üçì</span>AngleY</div>
          <div class="mono"><span id="ay">‚Äî</span>¬∞</div>
        </div>
        <div class="angleRow">
          <div class="angleLabel"><span class="leaf">üå∑</span>AngleZ</div>
          <div class="mono"><span id="az">‚Äî</span>¬∞</div>
        </div>
      </div>

      <canvas id="chart" height="220" style="margin-top:16px;"></canvas>
    </div>

    <div id="threeWrap">
      <div class="threeLabel">cute tractor orientation (3D)</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <script>
    // ---------- Chart ----------
    const MAX_POINTS = 200;
    const labels = [];
    const dataX = [];
    const dataY = [];
    const dataZ = [];

    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'AngleX (deg)', data: dataX, borderWidth: 1, pointRadius: 0 },
          { label: 'AngleY (deg)', data: dataY, borderWidth: 1, pointRadius: 0 },
          { label: 'AngleZ (deg)', data: dataZ, borderWidth: 1, pointRadius: 0 },
        ]
      },
      options: {
        animation: false,
        responsive: true,
        plugins: { legend: { labels: { boxWidth: 14 } } },
        scales: { x: { display: false }, y: { title: { display: true, text: 'degrees' } } }
      }
    });

    function pushPoint(ax, ay, az) {
      labels.push(new Date().toLocaleTimeString());
      dataX.push(ax); dataY.push(ay); dataZ.push(az);
      if (labels.length > MAX_POINTS) {
        labels.shift(); dataX.shift(); dataY.shift(); dataZ.shift();
      }
      chart.update('none');
    }

    // ---------- Three.js ----------
    const wrap = document.getElementById('threeWrap');
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf2fbff);

    const camera = new THREE.PerspectiveCamera(45, wrap.clientWidth / wrap.clientHeight, 0.1, 200);
    camera.position.set(0, 2.1, 7);
    camera.lookAt(0, 0, 0);

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(wrap.clientWidth, wrap.clientHeight);
    wrap.appendChild(renderer.domElement);

    scene.add(new THREE.AmbientLight(0xffffff, 0.65));
    const sun = new THREE.DirectionalLight(0xffffff, 1.0);
    sun.position.set(4, 7, 5);
    scene.add(sun);

    // Ground plane (cute field)
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(60, 60),
      new THREE.MeshStandardMaterial({ color: 0xcff5bf, roughness: 1.0, metalness: 0.0 })
    );
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -1.2;
    scene.add(ground);

    // Build a cute pink tractor from basic shapes
    const tractor = new THREE.Group();

    const pinkBodyMat = new THREE.MeshStandardMaterial({ color: 0xff5aa5, roughness: 0.65, metalness: 0.15 });
    const pinkHoodMat = new THREE.MeshStandardMaterial({ color: 0xff79b8, roughness: 0.65, metalness: 0.12 });
    const creamMat    = new THREE.MeshStandardMaterial({ color: 0xfff1c9, roughness: 0.75, metalness: 0.05 });
    const glassMat    = new THREE.MeshStandardMaterial({ color: 0xa9d8ff, roughness: 0.18, metalness: 0.0, transparent: true, opacity: 0.85 });
    const tireMat     = new THREE.MeshStandardMaterial({ color: 0x2b2b2b, roughness: 0.95, metalness: 0.05 });
    const rimMat      = new THREE.MeshStandardMaterial({ color: 0xffd36b, roughness: 0.55, metalness: 0.10 });
    const darkMat     = new THREE.MeshStandardMaterial({ color: 0x444444, roughness: 0.9, metalness: 0.2 });

    // Body (chassis)
    const body = new THREE.Mesh(new THREE.BoxGeometry(2.25, 0.72, 1.15), pinkBodyMat);
    body.position.set(0, 0.02, 0);
    tractor.add(body);

    const bodyTop = new THREE.Mesh(new THREE.BoxGeometry(1.9, 0.25, 1.05), pinkHoodMat);
    bodyTop.position.set(-0.15, 0.43, 0);
    tractor.add(bodyTop);

    // Hood (front)
    const hood = new THREE.Mesh(new THREE.BoxGeometry(1.15, 0.60, 1.10), pinkHoodMat);
    hood.position.set(1.38, 0.08, 0);
    tractor.add(hood);

    // Cute front grill
    const grill = new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.35, 0.75), creamMat);
    grill.position.set(1.95, 0.03, 0);
    tractor.add(grill);

    // Cab
    const cab = new THREE.Mesh(new THREE.BoxGeometry(1.05, 0.78, 1.05), creamMat);
    cab.position.set(-0.55, 0.72, 0);
    tractor.add(cab);

    // Windows
    const winFront = new THREE.Mesh(new THREE.BoxGeometry(0.85, 0.55, 0.03), glassMat);
    winFront.position.set(-0.55, 0.77, 0.54);
    tractor.add(winFront);

    const winSide = new THREE.Mesh(new THREE.BoxGeometry(0.03, 0.52, 0.82), glassMat);
    winSide.position.set(-1.05, 0.77, 0.0);
    tractor.add(winSide);

    // Exhaust pipe
    const exhaust = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 0.85, 18), darkMat);
    exhaust.position.set(1.72, 0.60, -0.36);
    tractor.add(exhaust);

    // Heart badge
    const heart = new THREE.Mesh(new THREE.SphereGeometry(0.10, 18, 18),
      new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.4, metalness: 0.05, emissive: 0xffd1e6, emissiveIntensity: 0.3 })
    );
    heart.scale.set(1.0, 0.8, 0.35);
    heart.position.set(0.1, 0.25, 0.60);
    tractor.add(heart);

    // Headlights
    function makeHeadlight(z){
      const h = new THREE.Mesh(new THREE.SphereGeometry(0.09, 16, 16),
        new THREE.MeshStandardMaterial({ color: 0xfff3c9, roughness: 0.25, metalness: 0.0, emissive: 0xfff0b3, emissiveIntensity: 0.5 })
      );
      h.position.set(1.95, 0.18, z);
      return h;
    }
    tractor.add(makeHeadlight(0.36));
    tractor.add(makeHeadlight(-0.36));

    // Cute "smile" bumper
    const bumper = new THREE.Mesh(
      new THREE.TorusGeometry(0.26, 0.055, 12, 24, Math.PI),
      new THREE.MeshStandardMaterial({ color: 0x8a5a2b, roughness: 0.9, metalness: 0.0 })
    );
    bumper.rotation.z = Math.PI;
    bumper.position.set(1.95, -0.03, 0);
    tractor.add(bumper);

    // --------------------------
    // Wheels: rotate CylinderGeometry 90¬∞ so axle is LEFT/RIGHT (Z-axis) like a real tractor.
    // Default cylinder axis is Y; rotating around X by +90¬∞ maps Y -> Z.
    // Also: offset a little hubcap outward so each side looks "correct".
    function makeWheel(radius, width, side /* +1 for left(+Z), -1 for right(-Z) */) {
      const wheel = new THREE.Group();

      const tire = new THREE.Mesh(new THREE.CylinderGeometry(radius, radius, width, 28), tireMat);
      tire.rotation.x = Math.PI / 2;          // ‚úÖ correct 90¬∞ wheel orientation (axle along Z)
      wheel.add(tire);

      const rim = new THREE.Mesh(new THREE.CylinderGeometry(radius * 0.55, radius * 0.55, width + 0.01, 24), rimMat);
      rim.rotation.x = Math.PI / 2;           // ‚úÖ match tire
      wheel.add(rim);

      // hubcap pushed slightly outward so left/right faces look correct
      const hub = new THREE.Mesh(
        new THREE.SphereGeometry(radius * 0.18, 18, 18),
        new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.45, metalness: 0.05 })
      );
      hub.scale.set(1, 1, 0.6);
      hub.position.z = side * (width * 0.52);
      wheel.add(hub);

      return wheel;
    }

    // Rear wheels (bigger)
    const rearL = makeWheel(0.58, 0.26, +1);
    rearL.position.set(-0.95, -0.28, 0.62);
    tractor.add(rearL);

    const rearR = makeWheel(0.58, 0.26, -1);
    rearR.position.set(-0.95, -0.28, -0.62);
    tractor.add(rearR);

    // Front wheels (smaller)
    const frontL = makeWheel(0.38, 0.22, +1);
    frontL.position.set(1.58, -0.36, 0.62);
    tractor.add(frontL);

    const frontR = makeWheel(0.38, 0.22, -1);
    frontR.position.set(1.58, -0.36, -0.62);
    tractor.add(frontR);

    // Lift tractor above ground
    tractor.position.y = 0.12;
    scene.add(tractor);

    // --------------------------
    // Barbie + Ken (cute farmer dolls) inside the cab, waving
    const dollSkinMat = new THREE.MeshStandardMaterial({ color: 0xffe0c2, roughness: 0.65, metalness: 0.05 });
    const blondeMat   = new THREE.MeshStandardMaterial({ color: 0xffe07a, roughness: 0.75, metalness: 0.05 });
    const denimMat    = new THREE.MeshStandardMaterial({ color: 0x6aa8ff, roughness: 0.8, metalness: 0.05 });
    const pinkOutfit  = new THREE.MeshStandardMaterial({ color: 0xff7ac0, roughness: 0.75, metalness: 0.05 });
    const whiteMat    = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.85, metalness: 0.02 });
    const hatMat      = new THREE.MeshStandardMaterial({ color: 0xf6e2b6, roughness: 0.9, metalness: 0.02 });

    function makeDoll({ outfitMat, hairStyle = "ponytail" }){
      const g = new THREE.Group();

      const head = new THREE.Mesh(new THREE.SphereGeometry(0.12, 18, 18), dollSkinMat);
      head.position.y = 0.45;
      g.add(head);

      const torso = new THREE.Mesh(new THREE.CapsuleGeometry(0.095, 0.18, 10, 18), outfitMat);
      torso.position.y = 0.28;
      g.add(torso);

      const hips = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.12, 0.11), outfitMat);
      hips.position.y = 0.16;
      g.add(hips);

      const legL = new THREE.Mesh(new THREE.CapsuleGeometry(0.05, 0.18, 8, 14), denimMat);
      legL.position.set(0.05, 0.03, 0);
      g.add(legL);

      const legR = legL.clone();
      legR.position.x = -0.05;
      g.add(legR);

      // arms
      const armL = new THREE.Group();
      const upperL = new THREE.Mesh(new THREE.CapsuleGeometry(0.035, 0.12, 8, 14), dollSkinMat);
      upperL.position.y = 0.02;
      armL.add(upperL);
      const handL = new THREE.Mesh(new THREE.SphereGeometry(0.035, 14, 14), dollSkinMat);
      handL.position.y = -0.09;
      armL.add(handL);
      armL.position.set(0.14, 0.34, 0);
      g.add(armL);

      const armR = new THREE.Group();
      const upperR = new THREE.Mesh(new THREE.CapsuleGeometry(0.035, 0.12, 8, 14), dollSkinMat);
      upperR.position.y = 0.02;
      armR.add(upperR);
      const handR = new THREE.Mesh(new THREE.SphereGeometry(0.035, 14, 14), dollSkinMat);
      handR.position.y = -0.09;
      armR.add(handR);
      armR.position.set(-0.14, 0.34, 0);
      g.add(armR);

      // hair
      const hair = new THREE.Mesh(new THREE.SphereGeometry(0.125, 18, 18), blondeMat);
      hair.scale.set(1.05, 0.85, 1.05);
      hair.position.y = 0.47;
      hair.position.z = -0.015;
      g.add(hair);

      if (hairStyle === "ponytail"){
        const pony = new THREE.Mesh(new THREE.SphereGeometry(0.06, 16, 16), blondeMat);
        pony.scale.set(1.0, 1.25, 1.0);
        pony.position.set(0.07, 0.42, -0.10);
        g.add(pony);
      }

      // little straw hat (farmer vibe)
      const brim = new THREE.Mesh(new THREE.CylinderGeometry(0.16, 0.16, 0.02, 24), hatMat);
      brim.rotation.x = Math.PI / 2;
      brim.position.y = 0.55;
      g.add(brim);
      const crown = new THREE.Mesh(new THREE.CylinderGeometry(0.10, 0.10, 0.07, 24), hatMat);
      crown.rotation.x = Math.PI / 2;
      crown.position.y = 0.58;
      g.add(crown);

      // return refs so we can animate waving
      g.userData.armL = armL;
      g.userData.armR = armR;

      return g;
    }

    const barbie = makeDoll({ outfitMat: pinkOutfit, hairStyle: "ponytail" });
    barbie.scale.set(1.0, 1.0, 1.0);
    barbie.position.set(-0.62, 0.42, 0.08);     // inside cab
    barbie.rotation.y = Math.PI;                // face forward-ish
    tractor.add(barbie);

    const ken = makeDoll({ outfitMat: denimMat, hairStyle: "short" });
    ken.position.set(-0.45, 0.42, -0.10);       // inside cab
    ken.rotation.y = Math.PI;
    tractor.add(ken);

    // --------------------------
    // Farm "Dreamhouse" background (cute pink farmhouse + barn-ish bits)
    function makeDreamhouse(){
      const house = new THREE.Group();

      const wallMat  = new THREE.MeshStandardMaterial({ color: 0xffa3d6, roughness: 0.85, metalness: 0.02 });
      const trimMat  = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.85, metalness: 0.02 });
      const roofMat  = new THREE.MeshStandardMaterial({ color: 0xff5aa5, roughness: 0.8, metalness: 0.03 });
      const doorMat  = new THREE.MeshStandardMaterial({ color: 0x7ee6ff, roughness: 0.7, metalness: 0.02 });

      const base = new THREE.Mesh(new THREE.BoxGeometry(3.6, 2.1, 2.4), wallMat);
      base.position.y = 1.05;
      house.add(base);

      const roof = new THREE.Mesh(new THREE.ConeGeometry(2.7, 1.2, 4), roofMat);
      roof.rotation.y = Math.PI / 4;
      roof.position.y = 2.55;
      house.add(roof);

      const porch = new THREE.Mesh(new THREE.BoxGeometry(1.9, 0.25, 1.0), trimMat);
      porch.position.set(0.6, 0.35, 1.15);
      house.add(porch);

      const door = new THREE.Mesh(new THREE.BoxGeometry(0.55, 1.05, 0.08), doorMat);
      door.position.set(0.6, 0.65, 1.28);
      house.add(door);

      // windows
      function window(x,y,z){
        const w = new THREE.Group();
        const pane = new THREE.Mesh(new THREE.BoxGeometry(0.55, 0.45, 0.06), glassMat);
        pane.position.set(x,y,z);
        w.add(pane);
        const frame = new THREE.Mesh(new THREE.BoxGeometry(0.62, 0.52, 0.03), trimMat);
        frame.position.set(x,y,z+0.02);
        w.add(frame);
        return w;
      }
      house.add(window(-0.7, 1.25, 1.22));
      house.add(window(1.6, 1.25, 1.22));

      // cute silo
      const silo = new THREE.Mesh(new THREE.CylinderGeometry(0.55, 0.55, 2.6, 28), new THREE.MeshStandardMaterial({ color: 0xffd36b, roughness: 0.85, metalness: 0.02 }));
      silo.position.set(-2.5, 1.3, -0.7);
      house.add(silo);
      const siloCap = new THREE.Mesh(new THREE.ConeGeometry(0.65, 0.65, 28), roofMat);
      siloCap.position.set(-2.5, 2.9, -0.7);
      house.add(siloCap);

      // little sign
      const signPost = new THREE.Mesh(new THREE.CylinderGeometry(0.06, 0.06, 1.0, 12), darkMat);
      signPost.position.set(2.1, 0.5, 1.2);
      house.add(signPost);
      const sign = new THREE.Mesh(new THREE.BoxGeometry(1.1, 0.55, 0.08), trimMat);
      sign.position.set(2.1, 0.9, 1.2);
      house.add(sign);

      return house;
    }

    const dreamhouse = makeDreamhouse();
    dreamhouse.position.set(-10, -1.2, -12); // far background
    dreamhouse.rotation.y = 0.55;
    scene.add(dreamhouse);

    // Cute clouds
    function cloud(x,y,z){
      const g = new THREE.Group();
      const puffMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.95, metalness: 0.0 });
      const p1 = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), puffMat);
      const p2 = new THREE.Mesh(new THREE.SphereGeometry(0.28, 16, 16), puffMat);
      const p3 = new THREE.Mesh(new THREE.SphereGeometry(0.25, 16, 16), puffMat);
      p1.position.set(0,0,0);
      p2.position.set(0.35,0.08,0.05);
      p3.position.set(-0.35,0.05,-0.05);
      g.add(p1); g.add(p2); g.add(p3);
      g.position.set(x,y,z);
      return g;
    }
    scene.add(cloud(-3.0, 2.0, -2.0));
    scene.add(cloud(2.6, 2.3, -2.4));

    // Animation loop (adds waving)
    const clock = new THREE.Clock();

    function render() {
      const t = clock.getElapsedTime();

      // Waving: raise right arms and oscillate a bit
      if (barbie?.userData?.armR) {
        barbie.userData.armR.rotation.z = -1.0 + Math.sin(t * 4.0) * 0.35;
        barbie.userData.armR.rotation.x = 0.3;
      }
      if (ken?.userData?.armR) {
        ken.userData.armR.rotation.z = -0.9 + Math.sin(t * 3.6 + 0.8) * 0.30;
        ken.userData.armR.rotation.x = 0.25;
      }

      renderer.render(scene, camera);
      requestAnimationFrame(render);
    }
    render();

    window.addEventListener('resize', () => {
      const w = wrap.clientWidth, h = wrap.clientHeight;
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
      renderer.setSize(w, h);
    });

    // Map angles to tractor rotation.
    function setTractorAngles(axDeg, ayDeg, azDeg) {
      tractor.rotation.x = THREE.MathUtils.degToRad(axDeg);
      tractor.rotation.y = THREE.MathUtils.degToRad(ayDeg);
      tractor.rotation.z = THREE.MathUtils.degToRad(azDeg);
    }

    // ---------- Web Serial ----------
    const connectBtn = document.getElementById('connectBtn');
    const statusEl = document.getElementById('status');
    const connDot = document.getElementById('connDot');
    const axEl = document.getElementById('ax');
    const ayEl = document.getElementById('ay');
    const azEl = document.getElementById('az');

    async function connectSerial() {
      if (!('serial' in navigator)) {
        alert('Web Serial not supported. Use Chrome/Edge desktop.');
        return;
      }

      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });

      statusEl.textContent = 'connected';
      connDot.classList.add('on');
      connectBtn.disabled = true;

      const textDecoder = new TextDecoderStream();
      port.readable.pipeTo(textDecoder.writable);
      const reader = textDecoder.readable.getReader();

      let buffer = '';
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          buffer += value;

          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            const s = line.trim();
            if (!s) continue;

            const parts = s.split(',');
            if (parts.length !== 3) continue;

            const ax = parseFloat(parts[0]);
            const ay = parseFloat(parts[1]);
            const az = parseFloat(parts[2]);
            if (![ax, ay, az].every(Number.isFinite)) continue;

            axEl.textContent = ax.toFixed(2);
            ayEl.textContent = ay.toFixed(2);
            azEl.textContent = az.toFixed(2);

            pushPoint(ax, ay, az);
            setTractorAngles(ax, ay, az);
          }
        }
      } catch (e) {
        console.error(e);
        alert('Serial error. Check Console (F12) for details.');
      } finally {
        statusEl.textContent = 'disconnected';
        connDot.classList.remove('on');
        connectBtn.disabled = false;
        try { reader.releaseLock(); } catch {}
        try { await port.close(); } catch {}
      }
    }

    connectBtn.addEventListener('click', connectSerial);
  </script>
</body>
</html>
